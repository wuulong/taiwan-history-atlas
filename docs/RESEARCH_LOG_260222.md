# 任務報告：[T260222-01] 分析台灣通史，建立 SQLite DB

## 1. 任務概要
將非結構化的《臺灣通史》純文字史料，轉化為具備「時空、人物、地理」維度的結構化 SQLite 資料庫，以利進行 HGIS (歷史地理資訊系統) 空間考證與高效檢索。

---

## 2. 建構方法 (Methodology)

採用 **「兩階段自動化 ETL 流程」**：

### Phase 1: 結構化匯入 (Structural Import) - [已完成]
*   **技術棧**：Python + SQLite3 + FTS5。
*   **流程**：
    1.  **TOC 映射**：解析史料前 340 行的目錄區，建立「卷號 (如卷三十一)」與「篇名 (如列傳三)」的對照表。
    2.  **標記切割**：利用 ctext 標記格式（如 `# 史卷一`、`# 卷三十一`）作為切割點，將 88 篇內容精確歸位。
    3.  **全文索引**：建立 FTS5 虛擬表，實現百萬字史料的毫秒級檢索。

### Phase 2: 智能實體萃取 (Entity Extraction) - [已完成 (全域掃描階段)]
*   **技術棧**：Python + Regex + SQLite。
*   **成果**：
    1.  **全域掃描**：已完成《臺灣通史》前 31 卷（含紀、志、列傳一至三）之全量實體掃描。
    2.  **水利專項 (Infrastructure)**：特別針對 `農業志` (Vol 27) 進行深度萃取，解鎖了全台數百條歷史埤圳（如：隆恩圳、曹公圳、八堡圳、瑠公圳等）。
    3.  **地名與行政區 (Location)**：萃取了清代行政階層（堡、里、莊、社）共 600+ 筆地點資訊。
    4.  **人物索引 (Person)**：建立 250+ 筆開拓先賢、官吏之實體鏈結。

### Phase 3: 自動化空間配對 (Auto-GeoCoding) - [已完成 (三層圖資全域對合階段)]
*   **技術棧**：Geopandas + SQLite + 1920s SHP 圖資 (街庄與大字層級) + 內政部地名資料庫。
*   **成果**：
    1.  **三層圖資比對**：腳本 (`geo_coding.py`) 同步啟動「街庄區 (`1920b`)」、「大字 (`1920a`)」與「內政部聚落點位 (`moi_settlements`)」構成的立體查詢網。
    2.  **上下文錨定 (Hierarchical Anchor)**：實作 `guess_anchor`，從 `mentions` 表中讀取地名在《臺灣通史》出現的段落（Snippet），利用關鍵字（如：淡水/艋舺 $\rightarrow$ 臺北州）進行行政區推斷，有效解決「同名異地」問題（如南部新莊與北部新莊的混淆）。
    3.  **座標寫入**：經過上下文雙層校準與內政部資料庫鉤稽，成功精確打上 **183 筆** 歷史聚落的 WGS84 座標點位，所有推論過程（是否使用 Anchor、精度級別）皆序列化存入 `meta_data` JSON 欄位中。
*   **配對邏輯 (Spatial Linkage Logic)**：
    1.  **第一層：名稱標籤硬對合 (Fuzzy Label Matching)**：將萃取出的地名（移除「莊、社、街、里」等特徵詞）與 `Taiwan_Historical_Admin_Mapping.md` 或 `walkgis.db` 的 POI 進行模糊匹配。
    2.  **第二層：行政階層錨定 (Hierarchical Anchor)**：利用卷次脈絡（如《淡水廳志》或特定人名篇章）提供範圍前綴（如：新竹/竹塹），解決全台同名問題（卷次脈絡 + 地名核心詞 = 唯一的地理 ID）。
    3.  **第三層：水利拓墾拓撲 (Infrastructure Topology)**：針對埤圳等線狀水利設施，與 Open Data 在地灌溉系統對齊；若為消失圳路，則比對 1920 年代「百年歷史地圖」圖層。
    4.  **第四層：地形空間驗證 (Terrain Verification)**：利用 20m DTM (數值地形模型) 驗證高程是否符合工程必然性（如：水路上下游相對高程），標記不符點位為需人工覆核。


---

## 3. 目前資料庫內容統計 (taiwan_history.db)

目前資料庫已整合多源歷史與空間資料，核心表統計如下：

| 實體類型 (Entity Type) / 資料表 | 數量 (Count) | 關鍵範例 / 描述 |
| :--- | :--- | :--- |
| **Infrastructure (水利/城池)** | **639** | 隆恩圳、曹公圳、瑠公圳、熱蘭遮城 |
| **Location (地點/行政區)** | **675** | 竹塹、新莊仔、六張犁莊、九芎林社 |
| **Person (人物)** | **254** | 王世傑、知縣曹謹、施世榜、姜朝鳳 |
| **Chronology (編年紀事)** | **150+** | 康熙、雍正、乾隆各朝代之關鍵紀事 |
| **moi_settlements (內政部古地名)** | **37,758** | 整合內政部聚落資料，提供後續空間對合與歷史溯源使用 |
| **meta_data (JSON 擴充欄位)** | **已實裝** | 所有實體表皆已擴充 `meta_data`，用於儲存錨定邏輯與置信度 |

---

## 4. 目前狀態與成果 (Current Status)

*   **自動化程度**：已實現從非結構化史料到「時空人物資料庫」的工業化轉化。
*   **數據價值**：成功在 `農業志` 中定位到「隆恩圳」及其分支（如六張犁圳、石壁潭圳）的歷史敘事，這些數據將直接對接 Smart Traveling Assistant 的地理大腦。

---

## 5. 下一步計畫 (Next Steps)

1.  ~~**[T260222-01-D] 空間座標對合 (Geo-Coding)**~~：已完成，透過內政部圖資與 1920s 圖資成功對合 183 筆。
2.  **[T260222-01-E] 跨時空聯動**：將《臺灣通史》的埤圳數據與現代 WalkGIS 流域圖資進行疊圖分析，識別消失的河道或圳路。
3.  ~~**[T260222-01-F] 視覺化展示**~~：[已完成] 產出「臺灣通史水利開拓圖」KML 檔案 (`data/history_texts/Taiwan_History_Geo.kml`)，包含座標與上下文 MetaData HTML 描述，可匯入 Google My Maps。

---

## 6. 資料庫導航與查詢模式 (Database Navigation & Query Patterns)

為加速後續 AI 代理程式對此 HGIS 資料庫的解析，特此記載已驗證的查詢路徑與資料特徵：

### 6.1 核心表關聯模式 (Join Schema)
若要查詢「特定卷次」中出現的「特定實體」，標準 SQL 路徑為：
`entities (e)` $\rightarrow$ `mentions (m)` $\rightarrow$ `contents (c)` $\rightarrow$ `volumes (v)`
*   **關聯鍵**：`e.id = m.entity_id`, `m.content_id = c.id`, `c.vol_id = v.id`。
*   **導航增強**：`contents` 表已新增 `sub_title` 欄位（萃取自《臺灣通史》目錄 TOC），可直接過濾小節名稱。
*   **範例**：查詢「列傳」中出現的人名與其所屬小節。
    ```sql
    SELECT DISTINCT c.sub_title, e.name FROM entities e 
    JOIN mentions m ON e.id = m.entity_id 
    JOIN contents c ON m.content_id = c.id 
    WHERE c.vol_id IN (SELECT id FROM volumes WHERE title LIKE '列傳%') 
    AND e.type = 'Person';
    ```

### 6.2 屬性萃取與摘要 (Metadata & Summary)
*   **JSON 欄位**：實體描述與空間參數儲存於 `entities.meta_data`。
*   **摘要查詢**：使用 `json_extract(meta_data, '$.summary')` 獲取由 `summarize_zun.py` 產出的歷史脈絡摘要。
*   **時空特徵**：摘要中通常包含「朝代/年份」關鍵字（如：康熙、雍正），可用於建立時間軸。

### 6.3 資料特徵與陷阱 (Data Nuances)
1.  **同名異寫**：史料中存在同名異寫（如：`瑠公圳` 與 `琉公圳`），查詢時應使用 `LIKE '%公圳%'` 或聯集查詢。
2.  **實體清理**：由於 Regex 萃取特性，部分人名可能包含前綴詞（如：`乃鑿大安圳`），後續分析建議進行 `name` 欄位的二次清洗。
3.  **卷次與脈絡**：`volumes` 表的 `title` 是最重要的導航指標（如：`農業志` 集中了 90% 的水利實體）。

### 6.4 常用快查指令 (Snippets)
*   **統計特定類型實體**：`SELECT type, count(*) FROM entities GROUP BY type;`
*   **找出某人關聯的所有段落**：`SELECT m.snippet FROM mentions m JOIN entities e ON m.entity_id = e.id WHERE e.name = '王世傑';`

---

## 7. Layer 2 知識中樞藍圖 (Knowledge Atlas Blueprint)

為提升 AI 對史料的綜合解析與預判能力，已建立 `ai_knowledge_atlas` 表，並規劃以下五大知識建模路徑。這些資產將作 Layer 2 的結構化記憶，供後續河流探索與 HGIS 分析調用：

### 7.1 水利開發與埤圳模型 (Eco_System)
*   **目標**：建立「埤圳 -> 開發者 -> 灌溉流域 -> 關聯史料」的對照矩陣。
*   **應用**：實地河流考察時，快速調用清代開發 DNA。

### 7.2 產業特產與經濟貿易區塊 (Economy)
*   **目標**：整理不同時期的產物分佈（樟腦、茶、糖、鹽）與地理勢力範圍。
*   **應用**：分析臺灣經濟重心轉移與國際貿易門戶變遷。

### 7.3 官職體系與權力結構 (Gov_Structure)
*   **目標**：結構化《職官志》中清代官職階層、職權與歷史演變。
*   **應用**：精準標定史料人物在當時社會權力地圖中的位置。

### 7.4 歷史衝突與因果事件鏈 (Conflict_Logic)
*   **目標**：建立「觸發點 -> 參與者 -> 處理方式 -> 結果」的衝突博弈模型。
*   **應用**：理解不同歷史階段的社會張力與族群博弈。

### 7.5 地名古今對照與演進矩陣 (Toponym_Ref)
*   **目標**：史料地名 -> 通用舊地名 -> 現代行政區 -> 歷史歸屬。
*   **應用**：實現跨時空的地理座標精準對齊，包含消失的番社與古聚落。

### 7.6 AI 作業模式與導航指引 (AI_Guidance)
*   **目標**：將已驗證的資料庫導航模式與查詢 SQL 範例入庫。
*   **應用**：確保不同 AI 代理程式能快速掌握資料庫操作精髓，實現知識傳承。

---

## 8. 知識建模攻克進度 (Knowledge Modeling Progress)

### 8.1 偵查與初步入庫 (Scouting Phase) - [已完成]
*   **理番據點 POI** (category: `Gov_Org`)：從《撫墾志》中萃取 20+ 個清代撫墾局與分局據點，對齊現代地名，幫助理解清代「以路帶墾」的戰時邊界感。
*   **原住民生活特徵矩陣** (category: `Ethnography`)：整合《開闢紀》與《撫墾志》，結構化 346+ 個關於族群習俗、戰鬥力與早期遷徙的特徵描述。

### 8.2 第一戰：全臺歷史水利模型 (Eco_System) - [已完成]
*   **日期**：2026-02-22
*   **目標**：結構化《農業志》收錄之全台歷史埤圳清單。
*   **成果**：
    *   從《農業志‧臺灣各屬陂圳表》中精煉並入庫 **226 筆** 結構化數據。
    *   **資料維度**：包含陂圳名稱、所在地、業戶/開鑿者、水源引自溪流、灌溉規模。
    *   **存入位置**：`ai_knowledge_atlas` 表。
*   **關鍵洞察**：
    *   **私有開發特質**：揭示臺灣早期水利多屬「業戶合築」而非全由政府主導（如施世榜之八堡圳、郭錫瑠之瑠公圳）。
    *   **流域空間關聯**：埤圳分佈與現代大甲溪、濁水溪、大肚溪等流域高度重疊，為 HGIS 「河道變遷」與「地名演進」提供精準的歷史參考坐標。

### 8.3 第二戰：產業特產與經濟貿易模型 (Economy) - [已完成]
*   **日期**：2026-02-22
*   **目標**：結構化《榷賣志》、《商務志》、《農業志》中關於鹽、糖、茶、樟腦的經濟數據與貿易脈絡。
*   **成果**：
    *   **鹽業 (Salt)**：追蹤從「瀨口」起源到清代四大場（州南、州北、瀨北、瀨南）的官辦演進。
    *   **樟腦 (Camphor)**：建立從嘉義私熬、英商購腦到劉銘傳「腦磺總局」官辦改革的歷史鏈。
    *   **糖業 (Sugar)**：解析「糖」生產組織（公司、頭家、牛奔）與「三郊」貿易體制。
    *   **茶業 (Tea)**：結構化從武夷引種到烏龍茶外銷美國、帶動艋舺大稻埕興起的商業路徑。
*   **關鍵洞察**：
    *   **特許經營權的權力轉移**：樟腦與鹽業的官辦與民辦之爭，反映了清廷地方財政與洋商利益的博弈。
    *   **南北產業格局形成**：中南部的糖與北部的茶、腦，共同形塑了清末台灣「南糖北茶」的經濟地理骨架。

### 8.4 第三戰：官職體系與權力結構模型 (Gov_Structure) - [已完成]
*   **日期**：2026-02-22
*   **目標**：結構化《職官志》中關於荷蘭、鄭氏、清代三時期的行政演變、官職清單與俸祿體系。
*   **成果**：
    *   **行政體系演變**：從鄭氏的「承天府/二縣/安撫司」到清末建省的「三府十一縣」層級演進。
    *   **官職職掌清單**：提取並結構化巡撫、布政使、分巡道、知府、同知、知縣、巡檢等數十種官階的設立與權責。
    *   **權力經濟模型**：記錄了乾隆年間增加「養廉銀」的具體數據（如巡道 1600 兩），反映了史觀中對吏治整肅的財政邏輯。
*   **關鍵洞察**：
    *   **外重內輕的行政趨勢**：清末沈葆楨與劉銘傳的奏摺顯示，臺灣行政重心從單純的「防內亂」轉向「對抗外侮與全面開發」，促成了巡撫駐台與建省。
    *   **理番行政的專業化**：從最初的同知兼管，到後續設立「撫墾總局」，顯示了清廷對原住民區域治權的逐步深入。

### 8.5 第四戰：歷史衝突與因果事件鏈模型 (Conflict_Logic) - [已完成]
*   **日期**：2026-02-22
*   **目標**：結構化《軍備志》、《獨立紀》與《撫墾志》中關於民變、械鬥、理番衝突與外侮防禦的邏輯範式。
*   **成果**：
    *   **民變模型 (Civil Rebellion)**：歸納「官逼民反」觸發鏈，識別天地會等祕密結社在社會動員中的角色（如朱一貴、林爽文事件）。
    *   **械鬥矩陣 (Ethnic Clash)**：分析漳泉、閩粵之間因資源（水利、土地）爭奪而起的空間武裝化現象。
    *   **理番衝突邏輯 (Frontier Conflict)**：對比「以石為界」的消極封禁與「以路帶墾」的積極擴張邏輯演變。
    *   **外防體系演進 (Foreign Defense)**：記錄從「防內輕外」到清末現代化海防（砲台、水雷、機器局）的戰略轉向。
*   **關鍵洞察**：
    *   **社會武裝化與空間分佈**：械鬥邏輯解釋了台灣聚落「防禦型結構」的地理成因，即地緣血緣重於行政管理。
    *   **衝突後的治理加速**：每一次重大衝突（如林爽文事件、牡丹社事件）後，往往伴隨著行政層級的提升或新制度的建立，衝突是臺灣近代化過程中的「負向推動力」。

### 8.6 第五戰：地名古今對照與演進矩陣 (Toponym_Ref) - [已完成]
*   **日期**：2026-02-22
*   **目標**：結構化《疆域志》中全台行政區域演變，並建立「古社名 -> 舊地名 -> 清末堡里」的映射矩陣。
*   **成果**：
    *   **核心地名演進矩陣**：捕捉從「諸羅 -> 嘉義」、「半線 -> 彰化」、「竹塹 -> 新竹」、「蛤仔難 -> 宜蘭」等 10+ 組關鍵行政命名變遷。
    *   **全臺堡里澳鄉名錄**：完整結構化清末三府、一州、三廳、十一縣下轄的所有具體「堡」、「里」、「澳」、「鄉」名稱。
    *   **命名地理學洞察**：分析南部「里」（鄭氏遺緒）與中北部「堡」（清代防禦特質）的地緣命名差異。
*   **關鍵洞察**：
    *   **從社名到吉祥命名**：反映了治魯邏輯從早期的「因襲舊俗（社名）」轉向中後期的「儒家化與王化宣示（嘉義、彰化）」。
    *   **消失的港口與地名殘留**：透過「鹽水港」、「鹿港」、「海豐港」等名稱，可回溯清代海岸線的變遷與淤積過程。

### 8.7 最終章：AI 作業模式與導航指引 (AI_Guidance) - [已完成]
*   **日期**：2026-02-22
*   **目標**：將今日開發的資料庫導航技巧、SQL 範例與 Layer 2 運作邏輯正式存入知識大腦。
*   **成果**：
    *   **導航元數據 (Meta-Navigation)**：記錄了如何利用 `sub_title` 進行跨卷次精準檢索。
    *   **SQL 算力遺產**：存入了一系列針對 `ai_knowledge_atlas` 的高效查詢 snippets。
    *   **層級協作邏輯**：定義了 AI 代理程式應優先調用 Layer 2 合成知識、再下鑽 Layer 1 實體、最後查核 Layer 0 原文的「三層分析模式」。
*   **意義**：
    *   **知識的自我傳承**：即使會話刷新或換人操作，AI 只要查詢 `category: AI_Guidance`，即可一秒繼承今日所有的導航經驗與操作默契。








